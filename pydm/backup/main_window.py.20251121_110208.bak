"""ä¸»çª—å£ - å®Œæ•´GUIç”¨æˆ·ä½“éªŒå‡çº§ç‰ˆ"""
import sys
import os
from PyQt5.QtWidgets import (QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
                             QTabWidget, QTextEdit, QPushButton, QLabel,
                             QLineEdit, QSpinBox, QMessageBox, QStatusBar)
from PyQt5.QtCore import QThread, pyqtSignal, Qt
from PyQt5.QtGui import QFont

sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

from damao_register.config_manager import ConfigManager, HWIDProfileManager
from damao_register.register_loop import RegisterLoop
from damao_register import logger
from gui.qt_logger import QTextEditLogger
from gui.virtual_code_tab import VirtualCodeTab
from gui.status_monitor import StatusMonitor
from gui.config_wizard import ConfigWizard


class RegisterThread(QThread):
    """æ³¨å†Œçº¿ç¨‹"""
    log_signal = pyqtSignal(str)
    status_signal = pyqtSignal(str, int, int)  # (status, current, total)
    
    def __init__(self, register_loop):
        super().__init__()
        self.register_loop = register_loop
    
    def run(self):
        self.register_loop.run()


class MainWindow(QMainWindow):
    """ä¸»çª—å£ - å®Œæ•´GUIç”¨æˆ·ä½“éªŒå‡çº§ç‰ˆ"""
    
    def __init__(self):
        super().__init__()
        self.config = ConfigManager()
        self.profile_mgr = HWIDProfileManager()
        self.register_loop = RegisterLoop(self.config, self.profile_mgr)
        self.register_thread = None
        self.qt_logger = None
        
        # æ£€æŸ¥æ˜¯å¦é¦–æ¬¡å¯åŠ¨
        self.check_first_run()
        
        self.init_ui()
        self.setup_logger()
        self.load_config()
    
    def check_first_run(self):
        """æ£€æŸ¥æ˜¯å¦é¦–æ¬¡å¯åŠ¨ï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºé…ç½®å‘å¯¼"""
        if not self.config.get_register_code() and self.config.get_machine_count() == 5:
            wizard = ConfigWizard(self.config)
            wizard.exec_()
    
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        self.setWindowTitle("å¤§æ¼ å…COMæ³¨å†Œç³»ç»Ÿ v2.0 - è™šæ‹Ÿæœºå™¨ç ç‰ˆ")
        self.setGeometry(100, 100, 1000, 700)
        
        # è®¾ç½®å­—ä½“
        font = QFont()
        font.setPointSize(9)
        self.setFont(font)
        
        # ä¸­å¤®éƒ¨ä»¶
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        layout = QVBoxLayout(central_widget)
        
        # æ ‡ç­¾é¡µ
        self.tabs = QTabWidget()
        layout.addWidget(self.tabs)
        
        # é…ç½®æ ‡ç­¾é¡µ
        config_tab = self.create_config_tab()
        self.tabs.addTab(config_tab, "âš™ï¸ é…ç½®")
        
        # è™šæ‹Ÿæœºå™¨ç ç®¡ç†æ ‡ç­¾é¡µ
        self.virtual_code_tab = VirtualCodeTab(self.profile_mgr)
        self.tabs.addTab(self.virtual_code_tab, "ğŸ”‘ è™šæ‹Ÿæœºå™¨ç ")
        
        # æ—¥å¿—æ ‡ç­¾é¡µ
        log_tab = self.create_log_tab()
        self.tabs.addTab(log_tab, "ğŸ“‹ æ—¥å¿—")
        
        # çŠ¶æ€ç›‘æ§
        self.status_monitor = StatusMonitor()
        layout.addWidget(self.status_monitor)
        
        # çŠ¶æ€æ 
        self.statusBar = QStatusBar()
        self.setStatusBar(self.statusBar)
        self.statusBar.showMessage("å°±ç»ª")
        
        # åº”ç”¨æ ·å¼
        self.apply_styles()
    
    def create_config_tab(self):
        """åˆ›å»ºé…ç½®æ ‡ç­¾é¡µ"""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # æ³¨å†Œç è®¾ç½®
        reg_group = QWidget()
        reg_layout = QVBoxLayout(reg_group)
        reg_layout.addWidget(QLabel("<b>æ³¨å†Œè®¾ç½®</b>"))
        
        reg_code_layout = QHBoxLayout()
        reg_code_layout.addWidget(QLabel("æ³¨å†Œç :"))
        self.reg_code_edit = QLineEdit()
        self.reg_code_edit.setPlaceholderText("ç•™ç©ºåˆ™ä»…ä½¿ç”¨åŸºç¡€åŠŸèƒ½")
        reg_code_layout.addWidget(self.reg_code_edit)
        reg_layout.addLayout(reg_code_layout)
        
        add_code_layout = QHBoxLayout()
        add_code_layout.addWidget(QLabel("é™„åŠ ç :"))
        self.add_code_edit = QLineEdit()
        self.add_code_edit.setPlaceholderText("å¯é€‰")
        add_code_layout.addWidget(self.add_code_edit)
        reg_layout.addLayout(add_code_layout)
        
        layout.addWidget(reg_group)
        
        # æœºå™¨è®¾ç½®
        machine_group = QWidget()
        machine_layout = QVBoxLayout(machine_group)
        machine_layout.addWidget(QLabel("<b>è™šæ‹Ÿæœºå™¨è®¾ç½®</b>"))
        
        count_layout = QHBoxLayout()
        count_layout.addWidget(QLabel("æœºå™¨æ•°é‡:"))
        self.machine_count_spin = QSpinBox()
        self.machine_count_spin.setRange(1, 100)
        count_layout.addWidget(self.machine_count_spin)
        count_layout.addWidget(QLabel("å°"))
        count_layout.addStretch()
        machine_layout.addLayout(count_layout)
        
        interval_layout = QHBoxLayout()
        interval_layout.addWidget(QLabel("æ³¨å†Œé—´éš”:"))
        self.interval_spin = QSpinBox()
        self.interval_spin.setRange(1, 120)
        interval_layout.addWidget(self.interval_spin)
        interval_layout.addWidget(QLabel("åˆ†é’Ÿ"))
        interval_layout.addStretch()
        machine_layout.addLayout(interval_layout)
        
        
        layout.addWidget(machine_group)
        
        # æŒ‰é’®åŒºåŸŸ
        button_layout = QHBoxLayout()
        
        save_btn = QPushButton("ğŸ’¾ ä¿å­˜é…ç½®")
        save_btn.clicked.connect(self.save_config)
        button_layout.addWidget(save_btn)
        
        wizard_btn = QPushButton("ğŸ§™ é…ç½®å‘å¯¼")
        wizard_btn.clicked.connect(self.show_wizard)
        button_layout.addWidget(wizard_btn)
        
        button_layout.addStretch()
        layout.addLayout(button_layout)
        
        # æ§åˆ¶æŒ‰é’®
        control_layout = QHBoxLayout()
        self.start_btn = QPushButton("â–¶ï¸ å¯åŠ¨æ³¨å†Œ")
        self.start_btn.clicked.connect(self.start_register)
        self.start_btn.setStyleSheet("QPushButton { background-color: #4CAF50; color: white; font-weight: bold; padding: 10px; }")
        control_layout.addWidget(self.start_btn)
        
        self.stop_btn = QPushButton("â¹ï¸ åœæ­¢æ³¨å†Œ")
        self.stop_btn.clicked.connect(self.stop_register)
        self.stop_btn.setEnabled(False)
        self.stop_btn.setStyleSheet("QPushButton { background-color: #f44336; color: white; font-weight: bold; padding: 10px; }")
        control_layout.addWidget(self.stop_btn)
        
        layout.addLayout(control_layout)
        
        layout.addStretch()
        return tab
    
    def create_log_tab(self):
        """åˆ›å»ºæ—¥å¿—æ ‡ç­¾é¡µ"""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # å·¥å…·æ 
        toolbar = QHBoxLayout()
        clear_btn = QPushButton("ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—")
        clear_btn.clicked.connect(self.clear_log)
        toolbar.addWidget(clear_btn)
        toolbar.addStretch()
        layout.addLayout(toolbar)
        
        # æ—¥å¿—æ˜¾ç¤º
        self.log_text = QTextEdit()
        self.log_text.setReadOnly(True)
        self.log_text.setFont(QFont("Consolas", 9))
        layout.addWidget(self.log_text)
        
        return tab
    
    def setup_logger(self):
        """è®¾ç½®å®æ—¶æ—¥å¿—"""
        # åˆ›å»ºQtæ—¥å¿—å¤„ç†å™¨
        self.qt_logger = QTextEditLogger(self.log_text)
        self.qt_logger.setFormatter(logger.get_logger().logger.handlers[0].formatter)
        
        # æ·»åŠ åˆ°å…¨å±€æ—¥å¿—å™¨
        logger.get_logger().logger.addHandler(self.qt_logger)
    
    def apply_styles(self):
        """åº”ç”¨æ ·å¼è¡¨"""
        self.setStyleSheet("""
            QMainWindow {
                background-color: #f5f5f5;
            }
            QTabWidget::pane {
                border: 1px solid #cccccc;
                background-color: white;
            }
            QTabBar::tab {
                background-color: #e0e0e0;
                padding: 8px 16px;
                margin-right: 2px;
            }
            QTabBar::tab:selected {
                background-color: white;
                border-bottom: 2px solid #2196F3;
            }
            QGroupBox {
                border: 1px solid #cccccc;
                border-radius: 5px;
                margin-top: 10px;
                padding-top: 10px;
            }
            QPushButton {
                border-radius: 4px;
                padding: 6px 12px;
            }
            QPushButton:hover {
                opacity: 0.8;
            }
        """)
    
    def load_config(self):
        """åŠ è½½é…ç½®"""
        self.machine_count_spin.setValue(self.config.get_machine_count())
        self.interval_spin.setValue(self.config.get_interval_minutes())
        self.reg_code_edit.setText(self.config.get_register_code())
        self.add_code_edit.setText(self.config.get_additional_code())
    
    def save_config(self):
        """ä¿å­˜é…ç½®"""
        self.config.set_machine_count(self.machine_count_spin.value())
        self.config.set_interval_minutes(self.interval_spin.value())
        self.config.set_register_code(self.reg_code_edit.text())
        self.config.set_additional_code(self.add_code_edit.text())
        QMessageBox.information(self, "æˆåŠŸ", "é…ç½®å·²ä¿å­˜")
        self.statusBar.showMessage("é…ç½®å·²ä¿å­˜", 3000)
    
    def show_wizard(self):
        """æ˜¾ç¤ºé…ç½®å‘å¯¼"""
        wizard = ConfigWizard(self.config)
        if wizard.exec_():
            self.load_config()
            self.virtual_code_tab.load_profiles()
    
    def clear_log(self):
        """æ¸…ç©ºæ—¥å¿—"""
        self.log_text.clear()
        self.statusBar.showMessage("æ—¥å¿—å·²æ¸…ç©º", 3000)
    
    def start_register(self):
        """å¯åŠ¨æ³¨å†Œ"""
        # æ£€æŸ¥é…ç½®æ•°é‡å¹¶è‡ªåŠ¨ç”Ÿæˆ
        current_count = len(self.profile_mgr.get_all_profiles())
        target_count = self.machine_count_spin.value()
        
        if current_count < target_count:
            # ç”Ÿæˆç¼ºå°‘çš„é…ç½®
            from damao_register.hwid_generator import HWIDGenerator
            for i in range(target_count - current_count):
                profile = HWIDGenerator.generate_profile()
                profile['id'] = current_count + i + 1
                profile['machine_code'] = 'æœªæ³¨å†Œ'  # æ·»åŠ æœºå™¨ç å­—æ®µ
                self.profile_mgr.add_profile(profile)
            
            # åˆ·æ–°è™šæ‹Ÿæœºå™¨ç é¡µé¢
            self.virtual_code_tab.load_profiles()
        
        self.start_btn.setEnabled(False)
        self.stop_btn.setEnabled(True)
        self.status_monitor.set_status("è¿è¡Œä¸­", "green")
        self.statusBar.showMessage("æ³¨å†Œå¾ªç¯å·²å¯åŠ¨")
        
        self.register_thread = RegisterThread(self.register_loop)
        self.register_thread.start()
    
    def stop_register(self):
        """åœæ­¢æ³¨å†Œ"""
        self.register_loop.stop()
        if self.register_thread:
            self.register_thread.wait()
        self.start_btn.setEnabled(True)
        self.stop_btn.setEnabled(False)
        self.status_monitor.set_status("å·²åœæ­¢", "orange")
        self.statusBar.showMessage("æ³¨å†Œå¾ªç¯å·²åœæ­¢")
    
    def closeEvent(self, event):
        """å…³é—­äº‹ä»¶"""
        if self.register_thread and self.register_thread.isRunning():
            reply = QMessageBox.question(
                self, "ç¡®è®¤é€€å‡º",
                "æ³¨å†Œå¾ªç¯æ­£åœ¨è¿è¡Œï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ",
                QMessageBox.Yes | QMessageBox.No
            )
            if reply == QMessageBox.Yes:
                self.stop_register()
                self.register_loop.cleanup()
                event.accept()
            else:
                event.ignore()
        else:
            self.register_loop.cleanup()
            event.accept()